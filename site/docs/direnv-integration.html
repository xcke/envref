<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>direnv Integration — envref docs</title>
  <meta name="description" content="Automatic environment resolution with direnv. Setup, profiles, strict mode, watch mode, and troubleshooting.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="doc.css">
</head>
<body>
  <!-- Nav -->
  <nav>
    <div class="nav-inner">
      <a href="../index.html" class="nav-logo">envref<span> /</span></a>
      <ul class="nav-links">
        <li><a href="../index.html#features">Features</a></li>
        <li><a href="../index.html#backends">Backends</a></li>
        <li><a href="../index.html#commands">Commands</a></li>
        <li><a href="../index.html#install">Install</a></li>
        <li><a href="../index.html#docs">Docs</a></li>
      </ul>
      <a href="https://github.com/xcke/envref" class="nav-github">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
        GitHub
      </a>
    </div>
  </nav>

  <div class="doc-layout">
    <aside class="doc-sidebar">
      <a href="../index.html" class="back-link">&larr; Home</a>
      <h4>Documentation</h4>
      <ul>
        <li><a href="getting-started.html">Getting Started</a></li>
        <li><a href="secret-backends.html">Secret Backends</a></li>
        <li><a href="profiles.html">Profiles</a></li>
        <li class="active"><a href="direnv-integration.html">direnv Integration</a></li>
      </ul>
    </aside>

    <main class="doc-content">
      <h1>direnv Integration</h1>
      <p class="doc-lead">envref integrates with <a href="https://direnv.net">direnv</a> to automatically resolve your environment variables when you <code>cd</code> into a project directory. This is the recommended way to use envref for local development.</p>

      <h2>Overview</h2>
      <p>direnv is a shell extension that loads/unloads environment variables based on the current directory. envref acts as a resolution layer — direnv calls <code>envref resolve --direnv</code> and <code>eval</code>s the output to inject resolved variables into your shell.</p>
      <pre><code>cd my-project/
  -&gt; direnv triggers
  -&gt; .envrc runs: eval &quot;$(envref resolve --direnv)&quot;
  -&gt; envref merges .env files, resolves ref:// from keychain
  -&gt; shell receives resolved KEY=VALUE exports</code></pre>

      <h2>Setup</h2>

      <h3>Prerequisites</h3>
      <p>Install direnv if you haven't already:</p>
      <pre><code><span class="comment"># macOS</span>
brew install direnv

<span class="comment"># Ubuntu/Debian</span>
sudo apt install direnv

<span class="comment"># From source</span>
go install github.com/direnv/direnv@latest</code></pre>

      <p>Add the direnv hook to your shell (add to <code>~/.bashrc</code>, <code>~/.zshrc</code>, etc.):</p>
      <pre><code><span class="comment"># Bash</span>
eval &quot;$(direnv hook bash)&quot;

<span class="comment"># Zsh</span>
eval &quot;$(direnv hook zsh)&quot;

<span class="comment"># Fish</span>
direnv hook fish | source</code></pre>

      <h3>Initialize with direnv support</h3>
      <pre><code>envref init --direnv</code></pre>
      <p>This creates the standard envref files (<code>.envref.yaml</code>, <code>.env</code>, <code>.env.local</code>) plus an <code>.envrc</code> file:</p>
      <pre><code><span class="comment"># .envrc (generated by envref init --direnv)</span>
eval &quot;$(envref resolve --direnv 2&gt;/dev/null)&quot; || true</code></pre>
      <p>If direnv is installed, <code>envref init --direnv</code> also runs <code>direnv allow</code> automatically. If direnv is not installed, it prints installation guidance.</p>

      <h3>Trust the .envrc</h3>
      <p>If the <code>.envrc</code> wasn't automatically trusted:</p>
      <pre><code>direnv allow</code></pre>
      <p>This tells direnv to trust and execute the <code>.envrc</code> in this directory.</p>

      <h2>How it works</h2>

      <h3>The resolve --direnv flag</h3>
      <p><code>envref resolve --direnv</code> outputs environment variables in <code>export KEY=VALUE</code> format, compatible with shell <code>eval</code>:</p>
      <pre><code><span class="prompt">$</span> <span class="cmd">envref resolve --direnv</span>
<span class="output">export APP_NAME=my-app
export APP_PORT=3000
export DATABASE_URL=postgres://user:secret@localhost/mydb
export API_KEY=sk-abc123</span></code></pre>
      <p>The <code>2&gt;/dev/null || true</code> in the <code>.envrc</code> ensures that if envref encounters an error (missing backend, locked vault), the shell still loads without failing.</p>

      <h3>Performance</h3>
      <p>envref is optimized for &lt;50ms startup with 100 variables. This matters because direnv calls <code>envref resolve</code> on every <code>cd</code> into the project directory, and slow resolve times would make navigation feel sluggish.</p>

      <h2>Using profiles with direnv</h2>

      <h3>Set a default profile</h3>
      <pre><code>envref profile use staging</code></pre>
      <p>The active profile in <code>.envref.yaml</code> is used automatically by <code>envref resolve --direnv</code>, so direnv will load the staging profile every time.</p>

      <h3>Override the profile</h3>
      <p>To temporarily use a different profile, modify your <code>.envrc</code>:</p>
      <pre><code><span class="comment"># .envrc</span>
eval &quot;$(envref resolve --direnv --profile production 2&gt;/dev/null)&quot; || true</code></pre>
      <p>Or set a profile per-directory by editing <code>.envref.yaml</code>:</p>
      <pre><code><span class="key">active_profile</span>: staging</code></pre>

      <h2>Strict mode</h2>
      <p>For CI environments or when you want to ensure all references resolve successfully, use <code>--strict</code>:</p>
      <pre><code><span class="comment"># .envrc for strict environments</span>
eval &quot;$(envref resolve --direnv --strict)&quot;</code></pre>
      <p>With <code>--strict</code>, <code>envref resolve</code> exits with a non-zero code and produces no output if any <code>ref://</code> reference cannot be resolved. This prevents partial environments from being loaded.</p>

      <h2>Watch mode</h2>
      <p>During development, you can use <code>envref resolve --watch</code> to automatically re-resolve when <code>.env</code> files change:</p>
      <pre><code>envref resolve --watch --direnv</code></pre>
      <p>This performs an initial resolve, then watches all <code>.env</code> files (<code>.env</code>, <code>.env.&lt;profile&gt;</code>, <code>.env.local</code>) via filesystem notifications. Changes are debounced (100ms) to handle rapid edits. Press Ctrl+C to stop.</p>
      <p>Note: Watch mode is a development convenience for seeing changes in real-time. For normal direnv usage, the standard <code>.envrc</code> setup (without <code>--watch</code>) is sufficient since direnv reloads on file changes automatically.</p>

      <h2>Troubleshooting</h2>

      <h3>direnv: error .envrc is blocked</h3>
      <p>Run <code>direnv allow</code> to trust the <code>.envrc</code> file. This is required after any change to <code>.envrc</code>.</p>

      <h3>Environment not loading</h3>
      <p>Check that envref can resolve successfully:</p>
      <pre><code>envref resolve --direnv</code></pre>
      <p>If this produces output, the issue is with direnv. If it errors, fix the envref configuration first.</p>

      <h3>Secrets not resolving</h3>
      <p>Verify your secrets are stored:</p>
      <pre><code>envref secret list
envref status</code></pre>
      <p>The <code>status</code> command shows which references are resolved and which are missing, with actionable hints.</p>

      <h3>Slow shell startup</h3>
      <p>If <code>cd</code> into the project feels slow:</p>
      <ol>
        <li>Check resolve time: <code>time envref resolve --direnv</code></li>
        <li>Target is &lt;50ms for 100 variables</li>
        <li>Ensure you're using the compiled binary, not <code>go run</code></li>
        <li>Check if backend access (keychain prompts) is adding latency</li>
      </ol>

      <h3>envref: command not found</h3>
      <p>Ensure envref is on your <code>$PATH</code>. If installed via <code>go install</code>, confirm <code>$GOPATH/bin</code> is in your path. If using a binary, move it to <code>/usr/local/bin</code> or another directory on your path.</p>

      <h2>Example: full setup</h2>
      <pre><code><span class="comment"># Install envref</span>
go install github.com/xcke/envref/cmd/envref@latest

<span class="comment"># Initialize project with direnv</span>
cd my-project
envref init --project my-app --direnv

<span class="comment"># Add secret references to .env</span>
cat .env
<span class="comment"># APP_NAME=my-app</span>
<span class="comment"># APP_PORT=3000</span>
<span class="comment"># DATABASE_URL=ref://secrets/database_url</span>
<span class="comment"># API_KEY=ref://secrets/api_key</span>

<span class="comment"># Store the secrets</span>
envref secret set database_url --value <span class="str">&quot;postgres://user:pass@localhost/mydb&quot;</span>
envref secret set api_key --value <span class="str">&quot;sk-abc123&quot;</span>

<span class="comment"># Verify resolution</span>
envref resolve

<span class="comment"># Leave and re-enter the directory to trigger direnv</span>
cd .. &amp;&amp; cd my-project
<span class="comment"># direnv: loading .envrc</span>
<span class="comment"># direnv: export +APP_NAME +APP_PORT +DATABASE_URL +API_KEY</span>

<span class="comment"># Confirm</span>
echo $API_KEY
<span class="comment"># sk-abc123</span></code></pre>

      <div class="see-also">
        <h2>See also</h2>
        <ul>
          <li><a href="getting-started.html">Getting Started</a> <span>— basic envref setup</span></li>
          <li><a href="profiles.html">Profiles</a> <span>— manage per-environment configurations</span></li>
          <li><a href="secret-backends.html">Secret Backends</a> <span>— configure where secrets are stored</span></li>
        </ul>
      </div>
    </main>
  </div>

  <footer>
    <div class="footer-links">
      <a href="https://github.com/xcke/envref">GitHub</a>
      <a href="https://github.com/xcke/envref/releases">Releases</a>
      <a href="getting-started.html">Docs</a>
      <a href="https://github.com/xcke/envref/blob/main/LICENSE">MIT License</a>
    </div>
    <p>envref — separate config from secrets</p>
  </footer>
</body>
</html>
